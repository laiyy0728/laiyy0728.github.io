<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><link rel="manifest" href="/images/manifest.json"><meta name="keywords" content="hadoop,yarn,"><link rel="alternate" href="/atom.xml" title="Laiyy 的个人小站" type="application/atom+xml"><meta name="description" content="Yarn 是一个资源调度平台，负责为运算程序提供服务器运算资源，相当于一个分布式的 操作系统，而 MapReduce 等运算程序相当于 操作系统上的应用程序"><meta name="keywords" content="hadoop,yarn"><meta property="og:type" content="article"><meta property="og:title" content="hadoop（18） YARN &lt;BR &#x2F;&gt; 资源调度器、Hadoop 优化"><meta property="og:url" content="https://www.laiyy.top/hadoop/yarn/hadoop-18.html"><meta property="og:site_name" content="Laiyy 的个人小站"><meta property="og:description" content="Yarn 是一个资源调度平台，负责为运算程序提供服务器运算资源，相当于一个分布式的 操作系统，而 MapReduce 等运算程序相当于 操作系统上的应用程序"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/yarn/yarn.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/yarn/yarn-scheduler-class.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/yarn/fifo.png"><meta property="og:updated_time" content="2019-12-16T07:33:32.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="hadoop（18） YARN &lt;BR &#x2F;&gt; 资源调度器、Hadoop 优化"><meta name="twitter:description" content="Yarn 是一个资源调度平台，负责为运算程序提供服务器运算资源，相当于一个分布式的 操作系统，而 MapReduce 等运算程序相当于 操作系统上的应用程序"><meta name="twitter:image" content="https://www.laiyy.top/images/hadoop/yarn/yarn.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.laiyy.top/hadoop/yarn/hadoop-18.html"><title>hadoop（18） YARN<br> 资源调度器、Hadoop 优化 | Laiyy 的个人小站</title><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/laiyy0728" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Laiyy 的个人小站</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-关于我"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于我</a></li><li class="menu-item menu-item-标签"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-分类"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-归档"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.laiyy.top/hadoop/yarn/hadoop-18.html"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="Laiyy"><meta itemprop="description" content=""><meta itemprop="image" content="/images/icon.jpg"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Laiyy 的个人小站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">hadoop（18） YARN<br> 资源调度器、Hadoop 优化</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-16T15:33:32+08:00">2019-12-16</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/hadoop/" itemprop="url" rel="index"><span itemprop="name">hadoop</span></a></span> ， <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/hadoop/yarn/" itemprop="url" rel="index"><span itemprop="name">yarn</span></a></span></span><div class="post-wordcount"> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">3.4k 字</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">12 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p>Yarn 是一个资源调度平台，负责为运算程序提供服务器运算资源，相当于一个分布式的 <code>操作系统</code>，而 MapReduce 等运算程序相当于 <code>操作系统上的应用程序</code></p><a id="more"></a><h1 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h1><p>Yarn 由 <code>ResourceManager</code>、<code>NodeManager</code>、<code>ApplicationMaster</code>、<code>Container</code> 等组件构成。</p><blockquote><p>ResourceManager</p></blockquote><ol><li>处理客户端请求</li><li>监控 NodeManager</li><li>启动或监控 ApplicationMaster</li><li>资源的分配和调度</li></ol><blockquote><p>NodeManager</p></blockquote><ol><li>管理单个节点上的资源</li><li>处理来自 ResourceManager 的命令</li><li>处理来自 ApplicationMaster 的命令</li></ol><blockquote><p>ApplicationMaster</p></blockquote><ol><li>负责数据的切分</li><li>为应用程序申请资源，并分配给内部的任务</li><li>任务的监控、容错</li></ol><blockquote><p>Container</p></blockquote><p>是 YARN 资源的抽象，封装了某个节点上的多维度资源，如：内存、CPU、磁盘、网络等。</p><hr><h1 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h1><ol><li>MapReduce 程序提交任务到客户端所在的节点</li><li>申请一个 Application 到 ResourceManager</li><li>ResourceManager 返回 <code>资源提交路径</code> 和 <code>application_id</code></li><li>将任务所需资源提交到 <code>资源提交路径</code> 上，包括切片信息(Job.Split)，任务信息（Job.xml）、所需 jar 包</li><li>资源提交完成后，申请运行 MrAppMaster</li><li>ResourceManager 将用户的请求初始化为一个 Task，进入任务队列</li><li>NodeManager 到 ResourceManager 领取 Task 任务</li><li>NodeManager 创建 Container 容器，分配 CPU、内存等资源，启动对应的 MrAppMaster</li><li>NodeManager 下载 job 资源到本地，MrAppMaster 读取切片信息，决定开启多少个 MapTask</li><li>Container 向 ResourceManager 申请运行 MapTask 容器</li><li>其余 NodeManager 重复 7-10 步骤，等待任务领取完成</li><li>任务领取完成后，MrAppMaster 统一发送程序运行脚本，启动 MapTask</li><li>所有 MapTask 执行完成后，由 MrAppMaster 向 ResourceManager 申请对应切片数量的 ReduceTask，进行 reduce 工作</li><li>ReduceTask 从 MapTask 中获取相应的数据</li><li>ReduceTask 执行完成后，MrAppMaster 想 ResourceManager 申请注销自己</li></ol><p><img src="/images/hadoop/yarn/yarn.png" alt="yarn"></p><hr><h1 id="资源调度器"><a href="#资源调度器" class="headerlink" title="资源调度器"></a>资源调度器</h1><p>资源调度器对应上图中的 <strong><em>FIFO调度队列</em></strong>。</p><p>Hadoop 资源调度器主要有三种：<code>FIFO(队列)</code>、<code>Capacity Scheduler(容量调度器)</code>、<code>Fair Scheduler(公平调度器)</code>， 默认资源调度器为 <code>Capacity Scheduler</code></p><p><img src="/images/hadoop/yarn/yarn-scheduler-class.png" alt="默认资源调度器"></p><h2 id="FIFO"><a href="#FIFO" class="headerlink" title="FIFO"></a>FIFO</h2><p>按照到达时间，先到先服务；单项执行</p><p>当有新的服务器节点资源时，从队列中获取一个任务，从任务重分配一个 Task 给节点进行服务</p><p><img src="/images/hadoop/yarn/fifo.png" alt="FIFO"></p><h2 id="Capacity-Scheduler"><a href="#Capacity-Scheduler" class="headerlink" title="Capacity Scheduler"></a>Capacity Scheduler</h2><p>Hadoop 默认调度器，按照到达时间，先到先服务；并发执行</p><blockquote><p>支持多个队列，每个队列可配置一定的资源量，每个队列采用 FIFO 调度策略<br>为防止同一个用户的作业独占队列中的资源，调度器会对同一个用户提交的作业所占资源量进行限制。<br>如果调度器中有三个队列，可以从三个队列的头部取出三个任务并发执行，相比 FIFO 提高了任务的执行速度。</p></blockquote><p>计算方式：<br>首先，计算每个队列中正在执行的任务数与其应该分得的资源之间的比值，选择一个最小（最闲）的队列；<br>其次，按照作业优先级和提交时间顺序，同时考虑用户资源量限制和内存限制对队列内的任务进项排序</p><h2 id="Fair-Scheduler"><a href="#Fair-Scheduler" class="headerlink" title="Fair Scheduler"></a>Fair Scheduler</h2><p>按照缺额排序，缺额越大越优先；并发度最高</p><blockquote><p>支持多队列、多用户<br>每个队列中的资源量可以配置<br>同一个队列中的作业公平共享队列的所有资源</p></blockquote><p>分配方式：<br>假设有三个队列：QA、QB、QC，每个队列中的任务按照优先级分配资源，优先级越高分配的资源越多。但是每个任务都会分配到资源，以确保 <code>公平</code>。<br>在资源有限的情况下，每个任务理想情况下获得的资源与实际获得的资源可能存在一定的差距，这个差距就称为 <code>缺额</code>。<br>通一个队列中，任务的资源缺额越大，越先获得资源优先执行。作业是按照缺额的高低来先后执行的，且多个作业同时运行。</p><h1 id="任务的推测执行"><a href="#任务的推测执行" class="headerlink" title="任务的推测执行"></a>任务的推测执行</h1><p><strong><em>作业完成时间取决于最慢任务的完成时间</em></strong></p><p>一个作业由若干个 Map 任务和 Reduce 任务构成，因硬件老化、软件 bug 等，某些任务可能运行的非常慢（如：99% 的Map 都完成了，少数的 Mpa 进度很慢完不成）</p><p>解决方案：</p><p>为慢的任务启动一个 <code>备份任务</code>，同时运行，谁先运行完就采用谁的结果。</p><blockquote><p>执行推测任务的前台条件</p></blockquote><ol><li>每个 Task 只能有一个备份任务</li><li>当前 Job 已完成的 Task 必须小于 5%</li><li>在 mapred-site.xml 中开启推测执行（默认是打开的）</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.map.speculative<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.reduce.speculative<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>不能启动推测任务的情况</p></blockquote><ol><li>任务间存在严重的负载倾斜</li><li>特殊任务（如向数据库中写数据）</li></ol><h2 id="推测方法"><a href="#推测方法" class="headerlink" title="推测方法"></a>推测方法</h2><p>假设某一时刻，任务 T 的执行进度为 progress，则可通过一定的算法来推测出该任务最终完成的时刻 <code>endTime</code>；另一方面，如果此刻为该任务开启一个备份任务，则可以推断出备份任务可能的完成时刻 <code>endTime1</code>。则：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">runTime = (currentTimestamp - taskStartTime) / progress</span><br><span class="line">推测运行时间 = (当前时刻 - 任务启动时刻) / 任务运行比例</span><br><span class="line"></span><br><span class="line">endTime = runTIme + taskStartTime</span><br><span class="line">推测结束时刻 = 运行时间 + 任务启动时刻</span><br><span class="line"></span><br><span class="line">entTime1 = currentTimestamp + avgRunTime</span><br><span class="line">备份任务推测完成时刻 = 当前时刻 + 运行完成任务的平均时间</span><br></pre></td></tr></table></figure><blockquote><p>MR 总是选择 entTime - endTime1 差值最大的任务，并为之启动备份任务<br>为防止大量任务同时启动备份任务造成资源浪费，MR 为每个作业设置了同时启动备份任务数目的上限<br>推测执行机制实际上采用了经典的优化方案：<code>以空间换时间</code>。同时启动多个相同的任务处理相同数据，并让这些任务竞争，以缩短数据处理时间。显然这种方法占用更多的计算资源。在集群资源紧缺的情况下，应合理使用，争取在多用少量资源的情况下，减少作业的计算时间</p></blockquote><hr><h1 id="Hadoop-优化"><a href="#Hadoop-优化" class="headerlink" title="Hadoop 优化"></a>Hadoop 优化</h1><h2 id="MapReduce-速度慢的原因"><a href="#MapReduce-速度慢的原因" class="headerlink" title="MapReduce 速度慢的原因"></a>MapReduce 速度慢的原因</h2><p>MapReduce 效率的瓶颈在于：计算机性能、IO 操作优化</p><p>计算机性能包括：</p><blockquote><p>CPU、内存、磁盘监控、网络</p></blockquote><p>IO 操作优化包括：</p><blockquote><p>数据倾斜<br>Map 和 Reduce 数设置不合理<br>Map 运行时间太长，导致 Reduce 等待太久<br>小文件过多<br>大量不可分块的超大文件<br>溢写次数过多<br>归并次数过多</p></blockquote><h2 id="优化方法"><a href="#优化方法" class="headerlink" title="优化方法"></a>优化方法</h2><p>可以从六个方面考虑优化：数据输入、Map、Reduce、IO、数据倾斜、参数调优</p><h3 id="数据输入"><a href="#数据输入" class="headerlink" title="数据输入"></a>数据输入</h3><blockquote><p>合并小文件</p></blockquote><p>在执行 MR 任务之前，将小文件进行合并，大量小文件会产生大量的 Map 任务，增加 Map 任务装载数，而任务的装载比较耗时，从而导致 MR 运行慢。</p><p>解决办法：采用 CombinerTextInputFormat 作为输入，解决输入端大量小文件的问题。</p><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><blockquote><p>减小溢写次数</p></blockquote><p>通过调整 <strong><em>mapred-site.xml</em></strong> 文件中的 <code>mapreduce.task.io.sort.mb</code> 和 <code>mapreduce.map.sort.spill.percent</code> 参数，增大触发溢写的内存上限，减少溢写次数，从而减小磁盘 IO</p><blockquote><p>减少合并次数</p></blockquote><p>通过调整 <strong><em>mapred-site.xml</em></strong> 文件中的 <code>mapreduce.task.io.sort.factor</code> 参数，增大合并的文件数目，减少合并次数，从而缩短 MR 处理时间</p><blockquote><p>在 Map 之后，不影响业务逻辑的前台下，先进行 Combine 处理，减少 IO（适用于汇总）</p></blockquote><h3 id="Reduce"><a href="#Reduce" class="headerlink" title="Reduce"></a>Reduce</h3><blockquote><p>合理设置 Map、Reduce 数</p></blockquote><p>影响 Map 个数的是 <code>切片</code>，影响 reduce 个数的是 <code>setNumReduceTasks</code> 方法。<br>这两个数值都不能设置太小，也不能太大。<br>太小会导致 Task 等待，处理时间长；太大会导致 Map、Reduce 任务间竞争资源，造成处理超时等错误</p><blockquote><p>设置 Map、Reduce 共存</p></blockquote><p>调整 <strong><em>mapred-site.xml</em></strong> 文件中的 <code>mapreduce.job.reduce.slowstart.completedmaps</code> 参数，使 Map 运行到一定程度后，Reduce 也开始运行，减少 Reduce 等待时间。</p><blockquote><p>规避使用 Reduce</p></blockquote><p>由于 Reduce 在用于连接数据集的时候会产生大量的网络消耗，如果不需要使用 Reduce，则可以进行规避，减少大量的 shuffle 时间</p><blockquote><p>合理设置 Reduce 的 buffer</p></blockquote><p>默认情况下，数据达到一个阈值的时候，Buffer 中的数据就会写入磁盘，然后 Reduce 会从磁盘中获得所有数据。<br>Buffer 和 Reduce 是没有直接关联的，中间有多次 <code>写磁盘 -&gt; 读磁盘</code> 的过程，可以通过调整参数来规避，使得 Buffer 中的一部分数据可以直接输送到 Reduce，减少 IO 开销。</p><p>通过调整 <strong><em>mapred-site.xml</em></strong> 文件中的 <code>mapreduce.reduce.input.buffer.percent</code> 配置，默认为 0.0。 当数值大于 0 时，会保留指定比例的内存读 Buffer 中的数据直接交给 Reduce，这样一来，设置 Buffer 需要内存、读取数据需要内存、Reduce 计算也需要内存，如果调整的不合理可能会撑爆服务器，因此需要根据作业运行情况去进行调整。</p><h3 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h3><blockquote><p>数据压缩</p></blockquote><p>安装 Snappy 或 LZO，开启数据压缩</p><blockquote><p>使用 SequenceFile 二进制文件</p></blockquote><h3 id="数据倾斜"><a href="#数据倾斜" class="headerlink" title="数据倾斜"></a>数据倾斜</h3><p>数据倾斜包含：数据频率倾斜（某一区域内的数据量远远大于其他区域）、数据大小倾斜（部分记录的大小远远大于平均值）</p><p><strong><em>解决方案</em></strong></p><blockquote><p>抽样和范围分区</p></blockquote><p>通过对原始数据进行抽样得到的结果集来预设分区边界值。</p><blockquote><p>自定义分区</p></blockquote><p>使用自定义分区，将某些 key 发送给固定的 Reduce 实例，将剩余 key 发送给剩余的 Reduce 实例</p><blockquote><p>Combine</p></blockquote><p>使用 Combine 可以大量较小数据倾斜，在可能的情况下，Combine 的目的就是聚合并精简数据</p><blockquote><p>采用 MapJoin，避免 ReduceJoin</p></blockquote><h3 id="参数设置"><a href="#参数设置" class="headerlink" title="参数设置"></a>参数设置</h3><blockquote><p>mapred-default.xml</p></blockquote><table><thead><tr><th style="text-align:center">参数</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">mapreduce.map.memory.mb</td><td style="text-align:center">一个 MapTask 可以使用的资源上线，默认 1024M。如果 MapTask 实际使用的资源超过该值，将被强制杀死</td></tr><tr><td style="text-align:center">mapreduce.reduce.memory.mb</td><td style="text-align:center">一个 ReduceTask 可以使用的资源上线，默认 1024M。如果 ReduceTask 实际使用的资源超过该值，将被强制杀死</td></tr><tr><td style="text-align:center">mapreduce.map.cpu.vcores</td><td style="text-align:center">一个 MapTask 可使用的最大 CPU 数目，默认 1</td></tr><tr><td style="text-align:center">mapreduce.reduce.cpu.vcores</td><td style="text-align:center">一个 ReduceTask 可使用的最大 CPU 数目，默认 1</td></tr><tr><td style="text-align:center">mapreduce.reduce.shuffle.parallelcopies</td><td style="text-align:center">每个 Reduce 去 Map 中获取数据的并行数，默认 5</td></tr><tr><td style="text-align:center">mapreduce.reduce.shuffle.merge.percent</td><td style="text-align:center">Buffer 中的数据达到多少比例开始写入磁盘，默认 0.66</td></tr><tr><td style="text-align:center">mapreduce.reduce.shuffle.input.buffer.percent</td><td style="text-align:center">Buffer 大小占 Reduce 可用内存的比例，默认 0.7</td></tr><tr><td style="text-align:center">mapreduce.reduce.input.buffer.percent</td><td style="text-align:center">指定多少比例的内存用来存放 Buffer 中的数据，默认 0.0</td></tr><tr><td style="text-align:center">mapreduce.task.io.sort.mb</td><td style="text-align:center">Shuffle 的环形缓冲区大小，默认 100M</td></tr><tr><td style="text-align:center">mapreduce.map.sort.spill.percent</td><td style="text-align:center">环形缓冲区溢写的阈值，默认 0.8</td></tr><tr><td style="text-align:center">mapreduce.map.maxattempts</td><td style="text-align:center">每个 MapTask 最大重试次数，超过该值认为 MapTask 失败，默认 4</td></tr><tr><td style="text-align:center">mapreduce.reduce.maxattempts</td><td style="text-align:center">每个 ReduceTask 最大重试次数，超过该值认为 ReduceTask 失败，默认 4</td></tr><tr><td style="text-align:center">mapreduce.task.timeout</td><td style="text-align:center">Task 超时时间，如果 Task 在一定时间内没有读取新数据，也没有输出数据，则认为 Task 处于 Block 状态，为防止因为用户程序永远 Block 不退出，则强制设置一个超时时间，默认为 10 分钟</td></tr></tbody></table><blockquote><p>yarn-default.xml</p></blockquote><table><thead><tr><th style="text-align:center">参数</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">yarn.scheduler.minimum-allocation-mb</td><td style="text-align:center">应用程序 Container 分配的最小内存，默认 1024</td></tr><tr><td style="text-align:center">yarn.scheduler.maximum-allocation-mb</td><td style="text-align:center">应用程序给 Container 份分配的最大内存，默认 8192</td></tr><tr><td style="text-align:center">yarn.scheduler.minimum-allocation-vcores</td><td style="text-align:center">每个 Container 申请最小 CPU 核数，默认 1</td></tr><tr><td style="text-align:center">yarn.scheduler.maximum-allocation-vcores</td><td style="text-align:center">每个 Container 申请的最大 CPU 核数，默认 4</td></tr><tr><td style="text-align:center">yarn.nodemanager.resource.memory-mb</td><td style="text-align:center">给 Container 分配的最大物理内存，默认 8192</td></tr></tbody></table><h2 id="小文件优化"><a href="#小文件优化" class="headerlink" title="小文件优化"></a>小文件优化</h2><blockquote><p>小文件弊端</p></blockquote><p>HDFS 上每个文件都要在 NameNode 上建立一个索引，索引大小约 150 byte，当小文件较多时会产生很多索引文件，一方面会大量占用 NameNode 的内存空间，另一方面就是索引文件过大，使得索引速度变慢。</p><blockquote><p>优化方式</p></blockquote><ol><li>在数据采集时，将小文件或小批数据合并为大文件再上传 HDFS</li><li>在业务处理前，在 HDFS 上使用 MapReduce 程序，对小文件进行合并</li><li>在 MapReduce 处理时，使用 CombineTextInputFormat 提高效率</li></ol><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><blockquote><p>Hadoop Archive</p></blockquote><p>归档是一个高效的将小文件放入 HDFS 块中的文件存档工具，能工将多个小文件打包为一个 HAR 文件，减少 NameNode 内存使用</p><blockquote><p>Sequence File</p></blockquote><p>由一系列二进制 KV 组成，如果 key 为文件名，value 为文件内存，则可以将大批小文件合并成一个大文件</p><blockquote><p>CombineFileInputFormat</p></blockquote><p>新的 InputFormat，用于将多个文件合并为一个单独的 Split，且它会考虑数据的存储位置</p><blockquote><p>开启 JVM 重用</p></blockquote><p>对于大量小文件的任务，可以开启 JVM 重用，会减少大约一半的运行时间。<br>JVM 重用原理：一个 Map 运行在一个 JVM 中，开启后，该 Map 在 JVM 上运行完毕后，JVM 会继续运行其他的 Map。<br>可以通过修改 <strong><em>mapred-site.xml</em></strong> 中的 <code>mapreduce.job.jvm.numtasks</code> 参数，默认为 1，即运行一个 Task 就销毁 JVM</p></div><div><div><div style="text-align:center;color:#bbb;font-size:15px"><br>-------------本文结束<i class="fa fa-paw"></i> 感谢您的阅读-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> Laiyy</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.laiyy.top/hadoop/yarn/hadoop-18.html" title="hadoop（18） YARN <BR /> 资源调度器、Hadoop 优化">https://www.laiyy.top/hadoop/yarn/hadoop-18.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/hadoop/" rel="tag"><i class="fa fa-tag"></i> hadoop</a><a href="/tags/yarn/" rel="tag"><i class="fa fa-tag"></i> yarn</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/hadoop/map-reduce/hadoop-17.html" rel="next" title="hadoop（17） Map Reduce <BR /> 计数器、压缩"><i class="fa fa-chevron-left"></i> hadoop（17） Map Reduce<br> 计数器、压缩</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/hadoop/map-reduce/hadoop-19.html" rel="prev" title="hadoop（19）Map Reduce <BR /> 多 Job 串联、Top N">hadoop（19）Map Reduce<br> 多 Job 串联、Top N<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="addthis_inline_share_toolbox"><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c42b60d6ef7b089" async="async"></script></div></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/icon.jpg" alt="Laiyy"><p class="site-author-name" itemprop="name">Laiyy</p><p class="site-description motion-element" itemprop="description">简介</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">88</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">19</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">35</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/laiyy0728" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:laiyy0728@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://www.jianshu.com/u/8fa6bf5f8bd9" target="_blank" title="简  书"><i class="fa fa-fw fa-book"></i> 简 书</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基础架构"><span class="nav-number">1.</span> <span class="nav-text">基础架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#工作机制"><span class="nav-number">2.</span> <span class="nav-text">工作机制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#资源调度器"><span class="nav-number">3.</span> <span class="nav-text">资源调度器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#FIFO"><span class="nav-number">3.1.</span> <span class="nav-text">FIFO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Capacity-Scheduler"><span class="nav-number">3.2.</span> <span class="nav-text">Capacity Scheduler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fair-Scheduler"><span class="nav-number">3.3.</span> <span class="nav-text">Fair Scheduler</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#任务的推测执行"><span class="nav-number">4.</span> <span class="nav-text">任务的推测执行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#推测方法"><span class="nav-number">4.1.</span> <span class="nav-text">推测方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hadoop-优化"><span class="nav-number">5.</span> <span class="nav-text">Hadoop 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MapReduce-速度慢的原因"><span class="nav-number">5.1.</span> <span class="nav-text">MapReduce 速度慢的原因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优化方法"><span class="nav-number">5.2.</span> <span class="nav-text">优化方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据输入"><span class="nav-number">5.2.1.</span> <span class="nav-text">数据输入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Map"><span class="nav-number">5.2.2.</span> <span class="nav-text">Map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reduce"><span class="nav-number">5.2.3.</span> <span class="nav-text">Reduce</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IO"><span class="nav-number">5.2.4.</span> <span class="nav-text">IO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据倾斜"><span class="nav-number">5.2.5.</span> <span class="nav-text">数据倾斜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参数设置"><span class="nav-number">5.2.6.</span> <span class="nav-text">参数设置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小文件优化"><span class="nav-number">5.3.</span> <span class="nav-text">小文件优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方案"><span class="nav-number">5.3.1.</span> <span class="nav-text">解决方案</span></a></li></ol></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_uv">UV:<span id="busuanzi_value_site_uv"></span></span></div> <span class="post-meta-divider">|</span><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_pv">PV:<span id="busuanzi_value_site_pv"></span></span></div><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">laiyy</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">网站总字数&#58;</span> <span title="网站总字数">151.9k 字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body></html><script type="text/javascript" src="/js/src/clipboard.min.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script>