<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><link rel="manifest" href="/images/manifest.json"><meta name="keywords" content="hadoop,hdfs,DataNode,trash,snapshot,"><link rel="alternate" href="/atom.xml" title="Laiyy 的个人小站" type="application/atom+xml"><meta name="description" content="在了解了 NameNode、SecondaryNameNode 的工作机制、FsImage 与 Edits 数据备份、NameNode 安全机制与多目录后，对 NameNode 有了一些基础了解。在此基础之上，接下来了解一下 DataNode 的工作机制。"><meta name="keywords" content="hadoop,hdfs,DataNode,trash,snapshot"><meta property="og:type" content="article"><meta property="og:title" content="Hadoop（8） &lt;br&#x2F;&gt; DataNode、小文件存档"><meta property="og:url" content="https://www.laiyy.top/hadoop/hdfs/hadoop-8.html"><meta property="og:site_name" content="Laiyy 的个人小站"><meta property="og:description" content="在了解了 NameNode、SecondaryNameNode 的工作机制、FsImage 与 Edits 数据备份、NameNode 安全机制与多目录后，对 NameNode 有了一些基础了解。在此基础之上，接下来了解一下 DataNode 的工作机制。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/datanode-work.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/check-sum.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/datanodes.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/05-upload-file.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/05-file-block.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/white-list.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/data-balance.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/decommission.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/before-har.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/har-suscceed.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/trash-warn.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/trash-succeed.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/no-snapshot.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/snapshot.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/snapshot1.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/rename-snapshot.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/client/delete-snapshot.png"><meta property="og:updated_time" content="2019-12-02T01:56:18.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Hadoop（8） &lt;br&#x2F;&gt; DataNode、小文件存档"><meta name="twitter:description" content="在了解了 NameNode、SecondaryNameNode 的工作机制、FsImage 与 Edits 数据备份、NameNode 安全机制与多目录后，对 NameNode 有了一些基础了解。在此基础之上，接下来了解一下 DataNode 的工作机制。"><meta name="twitter:image" content="https://www.laiyy.top/images/hadoop/client/datanode-work.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.laiyy.top/hadoop/hdfs/hadoop-8.html"><title>Hadoop（8）<br> DataNode、小文件存档 | Laiyy 的个人小站</title><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/laiyy0728" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Laiyy 的个人小站</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-关于我"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于我</a></li><li class="menu-item menu-item-标签"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-分类"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-归档"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.laiyy.top/hadoop/hdfs/hadoop-8.html"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="Laiyy"><meta itemprop="description" content=""><meta itemprop="image" content="/images/icon.jpg"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Laiyy 的个人小站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Hadoop（8）<br> DataNode、小文件存档</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-02T09:56:18+08:00">2019-12-02</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/hadoop/" itemprop="url" rel="index"><span itemprop="name">hadoop</span></a></span> ， <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/hadoop/hdfs/" itemprop="url" rel="index"><span itemprop="name">hdfs</span></a></span></span><div class="post-wordcount"> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">2.6k 字</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">11 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p>在了解了 NameNode、SecondaryNameNode 的工作机制、FsImage 与 Edits 数据备份、NameNode 安全机制与多目录后，对 NameNode 有了一些基础了解。在此基础之上，接下来了解一下 DataNode 的工作机制。</p><a id="more"></a><h1 id="DataNode-工作机制"><a href="#DataNode-工作机制" class="headerlink" title="DataNode 工作机制"></a>DataNode 工作机制</h1><p>DataNode 中存储的每个数据块，以文件形式存储在磁盘上。包括 2 个文件：数据本身、元数据(包括数据块的长度、校验和、时间戳)</p><ol><li>DataNode 启动后，向 NameNode 注册</li><li>NameNode 注册成功后，会同步在 NameNode 元数据中</li><li>DataNode 每个一个<code>固定的周期</code>向 NameNode 再注册（默认1小时）</li><li>DataNode 与 NameNode 以 <code>3 秒一次</code> 的心跳机制判断是否断开。心跳返回结果带有 NameNode 给 DataNode 的命令</li><li>NameNode 超过 <code>10 分钟</code>没有收到心跳，则认为该节点不可用</li></ol><p><img src="/images/hadoop/client/datanode-work.png" alt="DataNode 工作机制"></p><hr><h1 id="DataNode-数据完整性"><a href="#DataNode-数据完整性" class="headerlink" title="DataNode 数据完整性"></a>DataNode 数据完整性</h1><ol><li>当 DataNode 读取 Block 时，它会计算 CheckSum(校验和)</li><li>如果计算后的 CheckSum 与 Block 创建时的值不一样，说明 Block 已经损坏</li><li>Client 读取其他 DataNode 上的 Block</li><li>DataNode 在其文件创建后，周期性的验证 CheckSum</li></ol><p><img src="/images/hadoop/client/check-sum.png" alt="DataNode 数据完整性"></p><hr><h1 id="掉线时限"><a href="#掉线时限" class="headerlink" title="掉线时限"></a>掉线时限</h1><p>DataNode 进程死亡或者网路故障，造成 DataNode 与 NameNode 无法通信，NameNode 不会立即把该节点判定为 <code>死亡</code>，要经过一段时间后才会判定为死亡，这段时间称为 <code>超时时长</code>。HDFS 默认的超时时长为 10min + 30s</p><p>超时时长计算公示： <code>2 * dfs.namenode.heartbeat.recheck-interval + 10 * dfs.heartbeat.interval</code></p><p>具体可参考 <a href="https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/hdfs-default.xml" target="_blank" rel="noopener">官方文档</a>，默认值为： <code>dfs.namenode.heartbeat.recheck-interval</code> 5 分钟(300000)、<code>dfs.heartbeat.interval</code> 3秒（3s）</p><p>如果需要修改掉线时限，可以修改 <code>hdfs-site.xml</code> 文件。</p><hr><h1 id="服役新数据节点"><a href="#服役新数据节点" class="headerlink" title="服役新数据节点"></a>服役新数据节点</h1><p>现在已经有 3 台服务器构成了一个 hadoop 集群，如果现在需要在此基础上，再增加一个新的数据节点，就称为 <code>新数据节点服役</code>。</p><blockquote><p>环境准备</p></blockquote><ol><li>以 hadoop04 为主，克隆一台 hadoop05</li><li>修改 hadoop05 的 ip、主机名称</li><li>删除原来 HDFS 中的 <code>data/</code> 和 <code>log/</code></li><li>应用 <code>/etc/profile</code> 配置文件</li></ol><blockquote><p>服役新节点</p></blockquote><ol><li>启动原始集群 02、03、04</li><li>删除 05 的 <code>data/</code> 和 <code>log/</code></li><li>启动 05 的 DataNode(<code>sbin/hadoop-daemon.sh start datanode</code>)</li><li>启动 05 的 NodeManager(<code>sbin/yarn-daemon.sh start nodemanager</code>)</li><li>在 05 上上传文件进行测试</li><li>查看 WebUI 的 datanodes</li></ol><p><img src="/images/hadoop/client/datanodes.png" alt="datanodes"><br><img src="/images/hadoop/client/05-upload-file.png" alt="新 DataNode 上传文件"><br><img src="/images/hadoop/client/05-file-block.png" alt="新 DataNode 上传文件"></p><hr><h1 id="退役旧数据节点"><a href="#退役旧数据节点" class="headerlink" title="退役旧数据节点"></a>退役旧数据节点</h1><h2 id="主机白名单"><a href="#主机白名单" class="headerlink" title="主机白名单"></a>主机白名单</h2><p>添加到白名单里的主机节点，都允许访问 NameNode，否则不允许访问。</p><p>配置步骤：</p><blockquote><p>在 NameNode 的 <code>%HADOOP_HOME%/etc/hadoop</code> 目录下创建 <code>dfs.hosts</code> 文件，添加白名单（此次不添加 05）<br></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dfs.hosts</span></span><br><span class="line">hadoop02</span><br><span class="line">hadoop03</span><br><span class="line">hadoop04</span><br></pre></td></tr></table></figure><p></p></blockquote><blockquote><p>在 NameNode 的 <code>hdfs-site.xml</code> 文件中增加 dfs.hosts 配置</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置白名单 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.hosts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/module/hadoop-2.7.2/etc/hadoop/dfs.hosts<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>分发到 03、04，并刷新 NameNode</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop]# xsync hdfs-site.xml</span><br><span class="line">[root@hadoop02 hadoop]# hdfs dfsadmin -refreshNodes</span><br><span class="line">Refresh nodes successful</span><br></pre></td></tr></table></figure><blockquote><p>更新 ResourceManager</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop03 ~]# yarn rmadmin -refreshNodes</span><br><span class="line">19/12/02 14:26:29 INFO client.RMProxy: Connecting to ResourceManager at hadoop03/192.168.233.132:8033</span><br></pre></td></tr></table></figure><blockquote><p>查看 WebUI</p></blockquote><p>在执行上述操作的时候，02、03、04、05 都未关闭，也就是说，在执行上述操作之前，在 WebUI 的 DataNodes 中是可以看到 02、03、04、05 四台机器的。<br>在执行完上述操作后，再次查看 WebUI<br><img src="/images/hadoop/client/white-list.png" alt="白名单"></p><blockquote><p>如果数据不均衡，可以使用命令来实现集群的再平衡</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop-2.7.2]# sbin/start-balancer.sh </span><br><span class="line">starting balancer, logging to /opt/module/hadoop-2.7.2/logs/hadoop-root-balancer-hadoop02.out</span><br><span class="line">Time Stamp               Iteration#  Bytes Already Moved  Bytes Left To Move  Bytes Being Moved</span><br></pre></td></tr></table></figure><p>此时再查看 <code>README.TXT</code> 文件的块信息，由 05 变更到 02 上了。</p><p><img src="/images/hadoop/client/data-balance.png" alt="数据平衡"></p><h2 id="黑名单退役"><a href="#黑名单退役" class="headerlink" title="黑名单退役"></a>黑名单退役</h2><p>在黑名单上的主机会被强制退出。</p><p>在测试实现这种情况之前，需要将现场恢复，即将 hdfs-site.xml 中添加的白名单配置先注释掉，并刷新 NameNode 和 ResourceManager，启动 05 上的 DataNode</p><p>在 NameNode 的 <code>%HADOOP_HOME%/etc/hadoop</code> 目录下，创建 <code>dfs.hosts.exclude</code> 文件，并添加 05</p><p>修改 NameNode 上的 <code>hdfs-site.xml</code> 文件，增加 <code>dfs.hosts.exclude</code> 配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 黑名单 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.hosts.exclude<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/module/hadoop-2.7.2/etc/hadoop/dfs.hosts.exclude<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><p>刷新 NameNode、ResourceManager<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop]# hdfs dfsadmin -refreshNodes</span><br><span class="line">Refresh nodes successful</span><br><span class="line"></span><br><span class="line">[root@hadoop03 ~]# yarn rmadmin -refreshNodes</span><br><span class="line">19/12/02 14:26:29 INFO client.RMProxy: Connecting to ResourceManager at hadoop03/192.168.233.132:8033</span><br></pre></td></tr></table></figure><p></p><p>查看 WebUI，提示正在退役中(Decommission In Progress)，此时正在退役的节点会将数据块复制到其他节点上，保证数据的完整性。<br><img src="/images/hadoop/client/decommission.png" alt="退役节点"></p><p>稍等一会后再刷新页面，提示 05 节点已退役完成：Decommissioned。</p><p>如果数据不平衡，可以和白名单一样，使用 balance 命令平衡数据。</p><blockquote><p>需要注意的点：</p></blockquote><ol><li>等待退役节点状态为 <code>Decommissioned</code>，此时所有的块都已经复制完成，停止该节点及节点资源管理器。注意：如果副本数是 3，服役的节点小于等于 3，是不能退役的！需要修改副本数后才能退役！</li><li>不允许白名单和黑名单中存在同一个主机</li></ol><hr><h1 id="DataNode-多目录"><a href="#DataNode-多目录" class="headerlink" title="DataNode 多目录"></a>DataNode 多目录</h1><p>修改配置与 NameNode 多目录差不多，也是修改 <code>hdfs-site.xml</code>，增加如下配置<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:///$&#123;hadoop.tmp.dir&#125;/dfs/data1,file:///$&#123;hadoop.tmp.dir&#125;/dfs/data2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>分发到不同主机上后，重启 hadoop 集群即可。</p><blockquote><p>注意：</p></blockquote><p>DataNode 与 NameNode 不同，DataNode 每个目录中存放的数据<code>不一样</code>。数据不是副本！</p><hr><h1 id="小文件存档"><a href="#小文件存档" class="headerlink" title="小文件存档"></a>小文件存档</h1><h2 id="小文件存档的弊端"><a href="#小文件存档的弊端" class="headerlink" title="小文件存档的弊端"></a>小文件存档的弊端</h2><p>鉴于每个文件在 DataNode 中分块存储，每个块的元数据村存在 NameNode 中，因此 HDFS 存储小文件会非常低效。因为大量的小文件会耗尽 NameNode 中的大部分内存。<br>但是，需要注意的是，存储小文件所需要的磁盘容量和数据块的大小无关。</p><p>如：一个 1MB 的文件，设置为 128M 的块存储，实际使用的磁盘空间是 1MB，而不是 128MB。</p><h2 id="解决办法之一"><a href="#解决办法之一" class="headerlink" title="解决办法之一"></a>解决办法之一</h2><p>HDFS 存档文件或 HAR 文件，是一个更搞笑的文件存档工具，它将文件存在 HDFS 块，在减少 NameNode 内存使用的同时，允许对文件进行透明访问。<br>具体来说，HDFS 存档文件对内还是一个一个的独立文件，对外（NameNode）而言却是一个整体，减少了 NameNode 的内存。</p><blockquote><p>测试</p></blockquote><p>在 HDFS 中，存放几个测试文件：<br><img src="/images/hadoop/client/before-har.png" alt="before har"></p><p>文件压缩：<br></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数解释</span></span><br><span class="line"><span class="comment"># archive：开始文件压缩</span></span><br><span class="line"><span class="comment"># -archiveName：指定压缩的名称</span></span><br><span class="line"><span class="comment"># -p： 从那个目录，压缩到那个目录</span></span><br><span class="line">[root@hadoop03 hadoop-2.7.2]<span class="comment"># hadoop  archive -archiveName outout.har -p / /output</span></span><br></pre></td></tr></table></figure><p></p><p>执行完成后，查看 WebUI<br><img src="/images/hadoop/client/har-suscceed.png" alt="文件压缩后"></p><p>可以看到，文件成功输出了，但是我们看不到文件的内容是否和压缩前一致，解决办法：使用 <code>hadoop fs -ls -R har:///output/output.har</code> 命令查看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop-2.7.2]# hadoop fs -ls -R har:///output/outout.har</span><br><span class="line">-rw-r--r--   3 root supergroup      15429 2019-12-02 16:23 har:///output/outout.har/LICENSE.txt</span><br><span class="line">-rw-r--r--   3 root supergroup        101 2019-12-02 16:22 har:///output/outout.har/NOTICE.txt</span><br><span class="line">-rw-r--r--   3 root supergroup       1366 2019-12-02 16:22 har:///output/outout.har/README.txt</span><br></pre></td></tr></table></figure><p>文档解压：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop-2.7.2]# hadoop fs -cp har:///output/outout.har /har</span><br></pre></td></tr></table></figure><p></p><hr><h1 id="回收站"><a href="#回收站" class="headerlink" title="回收站"></a>回收站</h1><p>开启回收站功能，可以将删除的文件，在不超时的情况下，恢复原数据，起到防止误删、备份等作用。</p><h2 id="回收站参数设置及工作机制"><a href="#回收站参数设置及工作机制" class="headerlink" title="回收站参数设置及工作机制"></a>回收站参数设置及工作机制</h2><blockquote><p>开启回收站功能参数</p></blockquote><ol><li><code>fs.trash.interval</code>：默认值为 0，表示 <code>禁用回收站</code>，其他值表示该文件的存活时间，单位 <code>分钟</code></li><li><code>fs.trash.checkpoint.interval</code>：默认值为 0，表示 <code>检查回收站的时间间隔</code>，如果为 0，则该值与 <code>fs.trash.interval</code> 的时间间隔相同。单位 <code>分钟</code></li><li>要求：<code>fs.trash.checkpoint.interval</code> &lt;= <code>fs.trash.interval</code></li></ol><p>修改 <code>core-site.xml</code> 文件<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.trash.interval<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><blockquote><p>删除一条数据测试</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop03 hadoop-2.7.2]# hadoop fs -rm /README.txt</span><br><span class="line">19/12/02 17:31:15 INFO fs.TrashPolicyDefault: Namenode trash configuration: Deletion interval = 1 minutes, Emptier interval = 0 minutes.</span><br><span class="line">Moved: &apos;hdfs://hadoop02:9000/README.txt&apos; to trash at: hdfs://hadoop02:9000/user/root/.Trash/Current</span><br></pre></td></tr></table></figure><blockquote><p>在 WebUI 中查看回收站</p></blockquote><p><img src="/images/hadoop/client/trash-warn.png" alt="trash warn"></p><p>错误原因：进入垃圾回收站的默认用户名为 <code>dr.who</code>， 需要修改回收站用户名</p><p>修改 core-site.xml，并分发的 03、04 上，重启集群<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.http.staticuser.user<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>再次查看 WebUI：<br><img src="/images/hadoop/client/trash-succeed.png" alt="trash succeed"></p><hr><h1 id="快照管理"><a href="#快照管理" class="headerlink" title="快照管理"></a>快照管理</h1><p>快照，相当于对目录做了一次备份。此操作并 <em>不会立即赋值所有文件</em> ，而是 <em>指向同一个文件</em>。当写入发生时，才会产生新文件。</p><h2 id="常见命令"><a href="#常见命令" class="headerlink" title="常见命令"></a>常见命令</h2><blockquote><p>开启指定目录的快照功能： <code>hdfs dfsadmin -allowSnapshot &lt;path&gt;</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop-2.7.2]# hdfs dfsadmin -allowSnapshot /laiyy</span><br><span class="line">Allowing snaphot on /laiyy succeeded</span><br></pre></td></tr></table></figure><blockquote><p>禁用指定目录的快照功能(默认)：<code>hdfs dfsadmin -disallowSnapshot &lt;path&gt;</code><br>对指定目录创建快照：<code>hdfs dfs -createSnapshot &lt;path&gt;</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop-2.7.2]# hdfs dfs -createSnapshot /laiyy</span><br><span class="line">Created snapshot /laiyy/.snapshot/s20191203-135428.244</span><br></pre></td></tr></table></figure><p>此时在 WebUI 中是看不到快照文件的，因为这个快照文件是<code>隐藏文件</code>，输入 <code>/laiyy/.snapshot</code> 即可查看<br><img src="/images/hadoop/client/no-snapshot.png" alt="看不到快照"><br><img src="/images/hadoop/client/snapshot.png" alt="看到快照"><br><img src="/images/hadoop/client/snapshot1.png" alt="看到快照"></p><blockquote><p>创建目录快照并指定名称：<code>hdfs dfs -createSnapshot &lt;path&gt; &lt;name&gt;</code><br>快照重命名：<code>hdfs dfs -renameSnapshot &lt;path&gt; &lt;oldName&gt; &lt;newName&gt;</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop-2.7.2]# hdfs dfs -renameSnapshot /laiyy s20191203-135428.244 laiyy_snapshot</span><br></pre></td></tr></table></figure><p>查看 WebUI，可以看到快照名称已经修改了。<br><img src="/images/hadoop/client/rename-snapshot.png" alt="修改快照名称"></p><blockquote><p>列出当前用户可以快照的目录：<code>hdfs lsSnapshottableDir</code><br>比较两个快照目录的不同：<code>hdfs snapshotDiff &lt;path&gt; &lt;from&gt; &lt;to&gt;</code></p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># path 哪个路径的快照</span></span><br><span class="line"><span class="comment"># from、to：比较 form 和 to 两个快照的区别</span></span><br><span class="line"><span class="comment"># 此时的 from 用 "." 指代 /laiyy 文件夹，此时比较是没有任何区别的</span></span><br><span class="line">[root@hadoop02 hadoop-2.7.2]<span class="comment"># hdfs snapshotDiff /laiyy . .snapshot/laiyy_snapshot</span></span><br><span class="line">Difference between current directory and snapshot laiyy_snapshot under directory /laiyy:</span><br></pre></td></tr></table></figure><p>在已经创建快照之后，再往 /laiyy 下上传一个文件，比较结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop-2.7.2]# hdfs snapshotDiff /laiyy . .snapshot/laiyy_snapshot</span><br><span class="line">Difference between current directory and snapshot laiyy_snapshot under directory /laiyy:</span><br><span class="line">M	.</span><br><span class="line">-	./LICENSE.txt</span><br></pre></td></tr></table></figure><p>再创建一个新的快照，比较两个快照之间的区别</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop02 hadoop-2.7.2]# hdfs snapshotDiff /laiyy .snapshot/laiyy_snapshot .snapshot/laiyy_snapshot1</span><br><span class="line">Difference between snapshot laiyy_snapshot and snapshot laiyy_snapshot1 under directory /laiyy:</span><br><span class="line">M	.</span><br><span class="line">+	./LICENSE.txt</span><br></pre></td></tr></table></figure><blockquote><p>删除快照：<code>hdfs dfs -deleteSnapshot &lt;path&gt; &lt;name&gt;</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -deleteSnapshot /laiyy laiyy_snapshot</span><br></pre></td></tr></table></figure><p>查看 WebUI</p><p><img src="/images/hadoop/client/delete-snapshot.png" alt="删除快照"></p></div><div><div><div style="text-align:center;color:#bbb;font-size:15px"><br>-------------本文结束<i class="fa fa-paw"></i> 感谢您的阅读-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> Laiyy</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.laiyy.top/hadoop/hdfs/hadoop-8.html" title="Hadoop（8） <br/> DataNode、小文件存档">https://www.laiyy.top/hadoop/hdfs/hadoop-8.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/hadoop/" rel="tag"><i class="fa fa-tag"></i> hadoop</a><a href="/tags/hdfs/" rel="tag"><i class="fa fa-tag"></i> hdfs</a><a href="/tags/DataNode/" rel="tag"><i class="fa fa-tag"></i> DataNode</a><a href="/tags/trash/" rel="tag"><i class="fa fa-tag"></i> trash</a><a href="/tags/snapshot/" rel="tag"><i class="fa fa-tag"></i> snapshot</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/hadoop/hdfs/hadoop-7.html" rel="next" title="Hadoop（7） <br/> NameNode 和 SecondaryNameNode、集群安全模式"><i class="fa fa-chevron-left"></i> Hadoop（7）<br> NameNode 和 SecondaryNameNode、集群安全模式</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/hadoop/map-reduce/hadoop-9.html" rel="prev" title="hadoop（9） Map Reduce <BR />  基础概念，WordCount Demo 实现">hadoop（9） Map Reduce<br> 基础概念，WordCount Demo 实现<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="addthis_inline_share_toolbox"><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c42b60d6ef7b089" async="async"></script></div></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/icon.jpg" alt="Laiyy"><p class="site-author-name" itemprop="name">Laiyy</p><p class="site-description motion-element" itemprop="description">简介</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">65</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">10</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">26</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/laiyy0728" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:laiyy0728@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://www.jianshu.com/u/8fa6bf5f8bd9" target="_blank" title="简  书"><i class="fa fa-fw fa-book"></i> 简 书</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#DataNode-工作机制"><span class="nav-number">1.</span> <span class="nav-text">DataNode 工作机制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DataNode-数据完整性"><span class="nav-number">2.</span> <span class="nav-text">DataNode 数据完整性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#掉线时限"><span class="nav-number">3.</span> <span class="nav-text">掉线时限</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#服役新数据节点"><span class="nav-number">4.</span> <span class="nav-text">服役新数据节点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#退役旧数据节点"><span class="nav-number">5.</span> <span class="nav-text">退役旧数据节点</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#主机白名单"><span class="nav-number">5.1.</span> <span class="nav-text">主机白名单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#黑名单退役"><span class="nav-number">5.2.</span> <span class="nav-text">黑名单退役</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DataNode-多目录"><span class="nav-number">6.</span> <span class="nav-text">DataNode 多目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#小文件存档"><span class="nav-number">7.</span> <span class="nav-text">小文件存档</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#小文件存档的弊端"><span class="nav-number">7.1.</span> <span class="nav-text">小文件存档的弊端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解决办法之一"><span class="nav-number">7.2.</span> <span class="nav-text">解决办法之一</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#回收站"><span class="nav-number">8.</span> <span class="nav-text">回收站</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#回收站参数设置及工作机制"><span class="nav-number">8.1.</span> <span class="nav-text">回收站参数设置及工作机制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#快照管理"><span class="nav-number">9.</span> <span class="nav-text">快照管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#常见命令"><span class="nav-number">9.1.</span> <span class="nav-text">常见命令</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_uv">UV:<span id="busuanzi_value_site_uv"></span></span></div> <span class="post-meta-divider">|</span><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_pv">PV:<span id="busuanzi_value_site_pv"></span></span></div><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">laiyy</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">网站总字数&#58;</span> <span title="网站总字数">112.6k 字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/three/three.min.js"></script><script type="text/javascript" src="/lib/three/three-waves.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body></html><script type="text/javascript" src="/js/src/clipboard.min.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script>