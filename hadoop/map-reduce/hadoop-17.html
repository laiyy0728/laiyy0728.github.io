<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><link rel="manifest" href="/images/manifest.json"><meta name="keywords" content="hadoop,map-reduce,"><link rel="alternate" href="/atom.xml" title="Laiyy 的个人小站" type="application/atom+xml"><meta name="description" content="Hadoop 为每个作业维护若干个内置计数器，以描述多项指标。如：记录已处理的字节数和记录数，使用户可以监控已处理的输入数据量和已产生的输出数据量"><meta name="keywords" content="hadoop,map-reduce"><meta property="og:type" content="article"><meta property="og:title" content="hadoop（17） Map Reduce &lt;BR &#x2F;&gt; 计数器、压缩"><meta property="og:url" content="https://www.laiyy.top/hadoop/map-reduce/hadoop-17.html"><meta property="og:site_name" content="Laiyy 的个人小站"><meta property="og:description" content="Hadoop 为每个作业维护若干个内置计数器，以描述多项指标。如：记录已处理的字节数和记录数，使用户可以监控已处理的输入数据量和已产生的输出数据量"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/shuffle/log-before.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/shuffle/log-after.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/map-reduce/compress.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/map-reduce/decompress.png"><meta property="og:image" content="https://www.laiyy.top/images/hadoop/map-reduce/map-compress.png"><meta property="og:updated_time" content="2019-12-13T06:45:52.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="hadoop（17） Map Reduce &lt;BR &#x2F;&gt; 计数器、压缩"><meta name="twitter:description" content="Hadoop 为每个作业维护若干个内置计数器，以描述多项指标。如：记录已处理的字节数和记录数，使用户可以监控已处理的输入数据量和已产生的输出数据量"><meta name="twitter:image" content="https://www.laiyy.top/images/hadoop/shuffle/log-before.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.laiyy.top/hadoop/map-reduce/hadoop-17.html"><title>hadoop（17） Map Reduce<br> 计数器、压缩 | Laiyy 的个人小站</title><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/laiyy0728" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Laiyy 的个人小站</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-关于我"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于我</a></li><li class="menu-item menu-item-标签"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-分类"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-归档"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.laiyy.top/hadoop/map-reduce/hadoop-17.html"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="Laiyy"><meta itemprop="description" content=""><meta itemprop="image" content="/images/icon.jpg"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Laiyy 的个人小站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">hadoop（17） Map Reduce<br> 计数器、压缩</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-13T14:45:52+08:00">2019-12-13</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/hadoop/" itemprop="url" rel="index"><span itemprop="name">hadoop</span></a></span> ， <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/hadoop/map-reduce/" itemprop="url" rel="index"><span itemprop="name">map-reduce</span></a></span></span><div class="post-wordcount"> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">3k 字</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">12 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p>Hadoop 为每个作业维护若干个内置计数器，以描述多项指标。<br>如：记录已处理的字节数和记录数，使用户可以监控已处理的输入数据量和已产生的输出数据量</p><a id="more"></a><h1 id="计数器"><a href="#计数器" class="headerlink" title="计数器"></a>计数器</h1><p>计数器 API</p><blockquote><p>枚举方式计数<br>采用计数器组、计数器名称的方式计数<br>计数器结果在程序运行后，在控制台上查看</p></blockquote><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>在运行核心业务 MapReduce 之前，往往要先进行数据清洗，清理掉不符合用户要求的数据。清理过程往往只需要运行 Mapper 程序，不需要运行 Reduce 程序</p><p>使用一个项目中的日志信息作为输入数据，去除字段长度小于 11 的日志信息</p><p><strong><em>数据信息敏感，不公开</em></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        String line = value.toString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> result = parseLog(line, context);</span><br><span class="line">        <span class="keyword">if</span> (result)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        context.write(value, NullWritable.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseLog</span><span class="params">(String line, Context context)</span> </span>&#123;</span><br><span class="line">        String[] fields = line.split(<span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">if</span> (fields.length &gt; <span class="number">11</span>)&#123;</span><br><span class="line">            context.getCounter(<span class="string">"map"</span>, <span class="string">"true"</span>).increment(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        context.getCounter(<span class="string">"map"</span>, <span class="string">"false"</span>).increment(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取 job 对象</span></span><br><span class="line">    Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line"></span><br><span class="line">    Job job = Job.getInstance(configuration);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 jar 存放路径</span></span><br><span class="line">    job.setJarByClass(LogDriver.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关联 Mapper、Reducer 业务类</span></span><br><span class="line">    job.setMapperClass(LogMapper.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定最终输出的数据 KV 类型</span></span><br><span class="line">    job.setOutputKeyClass(Text.class);</span><br><span class="line">    job.setOutputValueClass(NullWritable.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定 job 的输入文件所在目录</span></span><br><span class="line">    FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(<span class="string">"D:\\dev\\log\\*"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定 job 的输出结果所在目录</span></span><br><span class="line">    FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(<span class="string">"D:\\dev\\log\\output"</span>));</span><br><span class="line"></span><br><span class="line">    job.setNumReduceTasks(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提交 job</span></span><br><span class="line">    <span class="keyword">boolean</span> succeed = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    System.exit(succeed ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>查看结果</p></blockquote><p>数据清洗前：<br><img src="/images/hadoop/shuffle/log-before.png" alt="数据清洗前"></p><p>数据清洗后：<br><img src="/images/hadoop/shuffle/log-after.png" alt="数据清洗后"></p><p><strong><em>具体更复杂的数据清洗，根据输入数据的不同进行高度定制化，此例只做基础概念思想</em></strong></p><hr><h1 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h1><p>压缩技术能够有效减少底层存储系统（HDFS）读写字节数。压缩提高了网络带宽和磁盘空间的效率。在运行 MapReduce 程序时，IO 操作、网络传输、shuffle 和 merge 要花费大量的时间，尤其是数据规模很大、工作负载密集的情况下，因此使用数据压缩非常重要。</p><p>磁盘IO 和网络带宽是 hadoop 的宝贵资源，数据压缩对于节省资源、最小化磁盘 IO、网络传输很有帮助；可以在 <strong><code>任意</code></strong> MapReduce 阶段启用压缩。压缩也是有代价的。</p><p>压缩是提高 hadoop 运行效率的一种优化策略，通过对 Mapper、Reduce 程序运行过程的数据进行压缩，以减少磁盘 IO，提高 MapReduce 程序运行速度。</p><p><strong><em>注意：采用压缩技术，减少了磁盘 IO，但同时增加了 CPU 运算负担，所以，压缩特性运用得当，能提高性能，但是运用不得当也可能降低性能</em></strong></p><blockquote><p>压缩基本原则</p></blockquote><ol><li>运算密集型的任务，少用压缩</li><li>IO 密集型的任务，多用压缩</li></ol><h2 id="压缩编码"><a href="#压缩编码" class="headerlink" title="压缩编码"></a>压缩编码</h2><table><thead><tr><th style="text-align:center">压缩格式</th><th style="text-align:center">是否 hadoop 自带</th><th style="text-align:center">算法</th><th style="text-align:center">文件扩展名</th><th style="text-align:center">是否可切分</th><th style="text-align:center">是否需要修改程序</th><th>对应编解码器</th></tr></thead><tbody><tr><td style="text-align:center">DEFLATE</td><td style="text-align:center">是</td><td style="text-align:center">DEFLATE</td><td style="text-align:center">.deflate</td><td style="text-align:center">否</td><td style="text-align:center">否</td><td>DefaultCodec</td></tr><tr><td style="text-align:center">GZIP</td><td style="text-align:center">是</td><td style="text-align:center">DEFLATE</td><td style="text-align:center">.gz</td><td style="text-align:center">否</td><td style="text-align:center">否</td><td>GzipCodec</td></tr><tr><td style="text-align:center">bzip2</td><td style="text-align:center">是</td><td style="text-align:center">bzip2</td><td style="text-align:center">.bz2</td><td style="text-align:center"><strong><em>是</em></strong></td><td style="text-align:center">否</td><td>BZip2Codec</td></tr><tr><td style="text-align:center">LZO</td><td style="text-align:center"><strong><em>否</em></strong></td><td style="text-align:center">LZO</td><td style="text-align:center">.lzo</td><td style="text-align:center"><strong><em>是</em></strong></td><td style="text-align:center"><strong><em>是，需要建索引、指定输入格式</em></strong></td><td>LzopCodec</td></tr><tr><td style="text-align:center">Snappy</td><td style="text-align:center"><strong><em>否</em></strong></td><td style="text-align:center">Snappy</td><td style="text-align:center">.snappy</td><td style="text-align:center">否</td><td style="text-align:center">否</td><td>SnappyCodec</td></tr></tbody></table><blockquote><p>性能比较</p></blockquote><table><thead><tr><th style="text-align:center">压缩算法</th><th style="text-align:center">原始文件大小</th><th style="text-align:center">压缩文件大小</th><th style="text-align:center">压缩速度</th><th style="text-align:center">解压速度</th></tr></thead><tbody><tr><td style="text-align:center">gzip</td><td style="text-align:center">8.3G</td><td style="text-align:center">1.8G</td><td style="text-align:center">17.5M/S</td><td style="text-align:center">58M/S</td></tr><tr><td style="text-align:center">bzip2</td><td style="text-align:center">8.3G</td><td style="text-align:center">1.1G</td><td style="text-align:center">2.4M/S</td><td style="text-align:center">9.5M/S</td></tr><tr><td style="text-align:center">LZO</td><td style="text-align:center">8.3G</td><td style="text-align:center">2.9G</td><td style="text-align:center">49.3M/S</td><td style="text-align:center">74.6M/S</td></tr></tbody></table><p>Snappy 在单核 i7 64 位处理器上，压缩速度可以达到 250M/S 以上，解压速度可以达到 500M/S 以上；但是压缩完的文件大小还是很大，且不可以切分。</p><h2 id="压缩方式对比"><a href="#压缩方式对比" class="headerlink" title="压缩方式对比"></a>压缩方式对比</h2><h3 id="GZip-压缩"><a href="#GZip-压缩" class="headerlink" title="GZip 压缩"></a>GZip 压缩</h3><blockquote><p>优点：</p></blockquote><ol><li>压缩率较高，压缩、解压速度较快</li><li>hadoop 本身支持，在应用中处理 gzip 文件和直接处理文本一样</li><li>大部分 linux 系统都自带 gzip 命令，使用方便</li></ol><blockquote><p>缺点：</p></blockquote><p>不支持切分</p><blockquote><p>应用场景</p></blockquote><p>当每个文件压缩后，文件大小在 130M 以内（即一个块大小的 1.1 倍以内），都可以考虑用 gzip 压缩。</p><h3 id="BZip2"><a href="#BZip2" class="headerlink" title="BZip2"></a>BZip2</h3><blockquote><p>优点</p></blockquote><ol><li>支持切分</li><li>压缩率高</li><li>hadoop 自带，使用方便</li></ol><blockquote><p>缺点</p></blockquote><p>压缩、解压速度慢</p><blockquote><p>应用场景</p></blockquote><ol><li>对速度要求不高，但是要求较高压缩率；</li><li>输出后的数据比较大，处理后的速度需要压缩存档减少磁盘空间并且以后数据用的比较少</li><li>对单个很大的文本文件向压缩以较少存储空间，同时需要支持切分，而且兼容之前的应用程序</li></ol><h3 id="LZO"><a href="#LZO" class="headerlink" title="LZO"></a>LZO</h3><blockquote><p>优点</p></blockquote><ol><li>压缩、解压速度快</li><li>压缩率合理</li><li>支持切分，hadoop 中最流行的压缩格式</li><li>可以在 linux 中安装 lzop 命令，使用方便</li></ol><blockquote><p>缺点</p></blockquote><ol><li>压缩率比 gzip 低</li><li>hadoop 本身不支持，需要安装</li><li>在应用中需要对 lzo 格式的文件做特殊处理（建索引、指定文件格式）</li></ol><blockquote><p>应用场景</p></blockquote><p>一个很大的文本文件，压缩后还大于 200M 以上的可以考虑。单个文件越大，lzo 优点越明显</p><h3 id="Snappy"><a href="#Snappy" class="headerlink" title="Snappy"></a>Snappy</h3><blockquote><p>优点</p></blockquote><ol><li>高速压缩、解压</li><li>压缩率合理</li></ol><blockquote><p>缺点</p></blockquote><ol><li>不支持切分</li><li>压缩率比 gzip 低</li><li>hadoop 本身不支持，需要安装</li></ol><blockquote><p>应用场景</p></blockquote><ol><li>当 MapReduce 的 Map 输出数据比较大，作为 Map 到 Reduce 的中间数据压缩格式</li><li>作为 MapReduce 作业的输出和另外一个 MapReduce 作业的输入</li></ol><h2 id="压缩位置的选择"><a href="#压缩位置的选择" class="headerlink" title="压缩位置的选择"></a>压缩位置的选择</h2><blockquote><p>Map 输入之前</p></blockquote><p>在有大量数据并计划重复处理的情况下，应该考虑对输入进行压缩。此时无需指定使用的压缩方式，hadoop 可以检查文件的扩展名，如果扩展名能够匹配，就会使用恰当的编解码方式对文件进行压缩，否则，hadoop 不会使用压缩</p><blockquote><p>Map 处理之后、Reduce 之前</p></blockquote><p>当 Mapper 任务输出的中间数据量很大时，应考虑再此阶段采用压缩技术，能够显著改善内部数据的 shuffle 过程；而 shuffle 过程在 hadoop 处理过程中是消耗资源最多的环节。<br>如果发现数据量大造成网络传输缓慢，应该考虑使用压缩技术，可以用于 Mapper 输出压缩的格式为：LZO、Snappy。</p><p>需要注意：<br>LZO 是提供 hadoop 压缩数据的通用压缩编解码器。设计目的是达到与硬盘读写速度相当的压缩速度，因此速度是优先考虑的因素，而不是压缩率。<br>与 gzip 编解码器相比，它的压缩速度是 gzip 的 5 倍，解压速度是 gzip 的 2 倍。<br>同一个文件用 LZO 压缩后，比用 gzip 压缩后大 50%，但是比压缩前小 25%~50%，这对于改善性能非常有利，Map 阶段完成时间快大概 4 倍。</p><blockquote><p>Reducer 输出</p></blockquote><p>此阶段启用压缩，能够减少要存储的数据量，因此降低所需的磁盘空间。<br>当 MapReduce 作业形成链条时，第二个作业的输入也以压缩，所以启用压缩同样有效。</p><h2 id="压缩参数的配置"><a href="#压缩参数的配置" class="headerlink" title="压缩参数的配置"></a>压缩参数的配置</h2><table><thead><tr><th style="text-align:center">参数</th><th style="text-align:center">默认值</th><th style="text-align:center">阶段</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td style="text-align:center"><code>io.compression.codecs</code>（core-site.xml）</td><td style="text-align:center">DefaultCodec、GzipCodec、BZipCodec</td><td style="text-align:center">输入压缩</td><td style="text-align:center">hadoop 使用文件扩展名判断是否支持某种编解码器</td></tr><tr><td style="text-align:center"><code>mapreduce.map.output.compress</code>（mapred-site.xml）</td><td style="text-align:center">false</td><td style="text-align:center">mapper 输出</td><td style="text-align:center">为 true 时启用压缩</td></tr><tr><td style="text-align:center"><code>mapreduce.map.output.compress.codec</code>（mapred-site.xml）</td><td style="text-align:center">DefaultCodec</td><td style="text-align:center">mapper 输出</td><td style="text-align:center">多用 LZO 或 Snappy</td></tr><tr><td style="text-align:center"><code>mapreduce.output.fileoutputformat.compress</code>（mapred-site.xml）</td><td style="text-align:center">false</td><td style="text-align:center">reduce 输出</td><td style="text-align:center">为 true 时启用压缩</td></tr><tr><td style="text-align:center"><code>mapreduce.output.fileoutputformat.compress.type</code>（mapred-site.xml）</td><td style="text-align:center">RECORD</td><td style="text-align:center">reduce 输出</td><td style="text-align:center">SequenceFile 输出使用的压缩类型（BLOCK、NONE、RECORD）</td></tr><tr><td style="text-align:center"><code>mapreduce.output.fileoutputformat.compress.codec</code>（mapred-site.xml）</td><td style="text-align:center">DefaultCodec</td><td style="text-align:center">reduce 输出</td><td style="text-align:center">具体的压缩编码</td></tr></tbody></table><h2 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h2><p>CompressionCodec 有两个方法可以用于轻松的压缩、解压数据。</p><p>想要对正在被写入一个输出流的数据进行压缩，可以使用 <code>createOutputStream</code> 方法创建一个 CompressionOutputStream，将其以压缩格式写入底层的流。<br>想要对输入数据进行嘉业，可以使用 <code>createInputStream</code> 方法床架一个 CompressionInputStream，从而从底层的流读取未压缩的数据</p><h3 id="压缩测试"><a href="#压缩测试" class="headerlink" title="压缩测试"></a>压缩测试</h3><p>输入数据：使用之前 <a href="/hadoop/map-reduce/input-format/hadoop-12.html#案例实操">CombinerTextInputFormat 示例</a> 中的 <a href="/file/hadoop/input-format/d.txt">输入数据 d.txt</a> 作为压缩测试的输入数据，测试不同压缩方式下的压缩率、耗时等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    String filePath = <span class="string">"d:/dev/wordcount/d.txt"</span>;</span><br><span class="line"><span class="comment">//        String type = "org.apache.hadoop.io.compress.BZip2Codec";</span></span><br><span class="line"><span class="comment">//        String type = "org.apache.hadoop.io.compress.DefaultCodec";</span></span><br><span class="line">    String type = <span class="string">"org.apache.hadoop.io.compress.GzipCodec"</span>;</span><br><span class="line">    compress(filePath, type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 测试压缩</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> path 待压缩文件路径</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> type 压缩方式</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">compress</span><span class="params">(String path, String type)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 获取输入流</span></span><br><span class="line">    FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(path));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 设置压缩方式</span></span><br><span class="line">    Class&lt;?&gt; compressClass = Class.forName(type);</span><br><span class="line">    <span class="comment">// 3. 反射获取编解码实例</span></span><br><span class="line">    CompressionCodec codec = (CompressionCodec) ReflectionUtils.newInstance(compressClass, <span class="keyword">new</span> Configuration());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 获取输出流，通过编解码实例获取后缀</span></span><br><span class="line">    FileOutputStream outputStream = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(path + codec.getDefaultExtension()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.创建压缩输出流</span></span><br><span class="line">    CompressionOutputStream codecOutputStream = codec.createOutputStream(outputStream);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 流的对拷</span></span><br><span class="line">    IOUtils.copyBytes(inputStream, codecOutputStream, <span class="number">1024</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. 关闭资源</span></span><br><span class="line">    IOUtils.closeStream(codecOutputStream);</span><br><span class="line">    IOUtils.closeStream(outputStream);</span><br><span class="line">    IOUtils.closeStream(inputStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试结果</p></blockquote><p>可见压缩前后数据大小的区别非常明显<br><img src="/images/hadoop/map-reduce/compress.png" alt="压缩结果"></p><h3 id="解压测试"><a href="#解压测试" class="headerlink" title="解压测试"></a>解压测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"><span class="comment">//        String path = "d:/dev/wordcount/d.txt.bz2";</span></span><br><span class="line"><span class="comment">//        String path = "d:/dev/wordcount/d.txt.gz";</span></span><br><span class="line">    String path = <span class="string">"d:/dev/wordcount/d.txt.deflate"</span>;</span><br><span class="line">    decompress(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decompress</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// 1. 校验文件是否可以解压</span></span><br><span class="line">    CompressionCodecFactory factory = <span class="keyword">new</span> CompressionCodecFactory(<span class="keyword">new</span> Configuration());</span><br><span class="line">    CompressionCodec codec = factory.getCodec(<span class="keyword">new</span> Path(path));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == codec)&#123;</span><br><span class="line">        System.out.println(<span class="string">"不支持压缩"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 获取输入流</span></span><br><span class="line">    FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(path);</span><br><span class="line">    CompressionInputStream codecInputStream = codec.createInputStream(inputStream);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 获取输出流</span></span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(path + <span class="string">".txt"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 流对拷</span></span><br><span class="line">    IOUtils.copyBytes(codecInputStream, fileOutputStream, <span class="number">1024</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 关闭流</span></span><br><span class="line">    IOUtils.closeStream(fileOutputStream);</span><br><span class="line">    IOUtils.closeStream(codecInputStream);</span><br><span class="line">    IOUtils.closeStream(inputStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试结果</p></blockquote><p><img src="/images/hadoop/map-reduce/decompress.png" alt="解压测试"></p><h3 id="Map-输出端采用压缩"><a href="#Map-输出端采用压缩" class="headerlink" title="Map 输出端采用压缩"></a>Map 输出端采用压缩</h3><p>即是 MapReduce 的输入、输出文件都是未压缩的文件，仍然可以对 Map 任务的中间结果输出做压缩（原因是 Map 结束后要将文件写入磁盘，并通过网络传输到 Reduce 节点，对其压缩可以提高很多性能）</p><p>Hadoop 源码支持的压缩格式有：<code>BZip2Codec</code>、<code>DefaultCodec</code></p><blockquote><p>基于 <a href="/hadoop/map-reduce/input-format/hadoop-12.html#案例实操">CombinerTextInputFormat 示例</a> 进行操作。</p></blockquote><p>首先执行 wordcount 实例，查看控制台 MapReduce 过程的字节数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Map-Reduce Framework</span><br><span class="line">    Map input records=3792092</span><br><span class="line">    Map output records=5056134</span><br><span class="line">    Map output bytes=50561388</span><br><span class="line">    Map output materialized bytes=60673704</span><br><span class="line">    Input split bytes=778</span><br><span class="line">    Combine input records=0</span><br><span class="line">    Combine output records=0</span><br><span class="line">    Reduce input groups=10</span><br><span class="line">    Reduce shuffle bytes=60673704</span><br><span class="line">    Reduce input records=5056134</span><br><span class="line">    Reduce output records=10</span><br><span class="line">    Spilled Records=10112268</span><br><span class="line">    Shuffled Maps =8</span><br><span class="line">    Failed Shuffles=0</span><br><span class="line">    Merged Map outputs=8</span><br><span class="line">    GC time elapsed (ms)=259</span><br><span class="line">    Total committed heap usage (bytes)=8830582784</span><br><span class="line"></span><br><span class="line">压缩前总耗时：9090 ms</span><br></pre></td></tr></table></figure><p>修改 WordCountDriver，增加压缩配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启压缩</span></span><br><span class="line">configuration.set(<span class="string">"mapreduce.map.output.compress"</span>, <span class="string">"true"</span>);</span><br><span class="line"><span class="comment">// 指定压缩格式</span></span><br><span class="line">configuration.setClass(<span class="string">"mapreduce.map.output.compress.codec"</span>, BZip2Codec.class, CompressionCodec.class);</span><br></pre></td></tr></table></figure><p>再次运行测试，查看控制台 MapReduce 过程字节数（开启压缩后的程序会比开启压缩前要慢很多）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Map-Reduce Framework</span><br><span class="line">    Map input records=3792092</span><br><span class="line">    Map output records=5056134</span><br><span class="line">    Map output bytes=50561388</span><br><span class="line">    Map output materialized bytes=207808</span><br><span class="line">    Input split bytes=778</span><br><span class="line">    Combine input records=0</span><br><span class="line">    Combine output records=0</span><br><span class="line">    Reduce input groups=10</span><br><span class="line">    Reduce shuffle bytes=207808</span><br><span class="line">    Reduce input records=5056134</span><br><span class="line">    Reduce output records=10</span><br><span class="line">    Spilled Records=10112268</span><br><span class="line">    Shuffled Maps =8</span><br><span class="line">    Failed Shuffles=0</span><br><span class="line">    Merged Map outputs=8</span><br><span class="line">    GC time elapsed (ms)=286</span><br><span class="line">    Total committed heap usage (bytes)=7362576384</span><br><span class="line"></span><br><span class="line">压缩总耗时：312134 ms</span><br></pre></td></tr></table></figure><p><img src="/images/hadoop/map-reduce/map-compress.png" alt="压缩前后字节数对比"></p><h3 id="Reduce-输出压缩"><a href="#Reduce-输出压缩" class="headerlink" title="Reduce 输出压缩"></a>Reduce 输出压缩</h3><p>还是以上例为例，将 map 压缩注释掉（为了快速测试 reduce 压缩，省去 map 压缩的等待时间），增加如下配置，开启 reduce 压缩<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启 reduce 压缩</span></span><br><span class="line">FileOutputFormat.setCompressOutput(job, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采用 bzip 压缩</span></span><br><span class="line">FileOutputFormat.setOutputCompressorClass(job, BZip2Codec.class);</span><br><span class="line"><span class="comment">// 采用gzip压缩</span></span><br><span class="line"><span class="comment">//FileOutputFormat.setOutputCompressorClass(job, GzipCodec.class);</span></span><br><span class="line"><span class="comment">// 采用默认压缩</span></span><br><span class="line"><span class="comment">//FileOutputFormat.setOutputCompressorClass(job, DefaultCodec.class);</span></span><br></pre></td></tr></table></figure><p></p><p>测试三种压缩方式的执行耗时，由于文件过小，实际总耗时相差无几。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reduce bz2 总耗时：9132</span><br><span class="line">reduce gz 总耗时：9166</span><br><span class="line">reduce default 总耗时：9038</span><br></pre></td></tr></table></figure></div><div><div><div style="text-align:center;color:#bbb;font-size:15px"><br>-------------本文结束<i class="fa fa-paw"></i> 感谢您的阅读-------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> Laiyy</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.laiyy.top/hadoop/map-reduce/hadoop-17.html" title="hadoop（17） Map Reduce <BR /> 计数器、压缩">https://www.laiyy.top/hadoop/map-reduce/hadoop-17.html</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/hadoop/" rel="tag"><i class="fa fa-tag"></i> hadoop</a><a href="/tags/map-reduce/" rel="tag"><i class="fa fa-tag"></i> map-reduce</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/hadoop/map-reduce/map-join/hadoop-16.html" rel="next" title="hadoop（16） Map Reduce <BR /> ReduceJoin、MapJoin"><i class="fa fa-chevron-left"></i> hadoop（16） Map Reduce<br> ReduceJoin、MapJoin</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/hadoop/yarn/hadoop-18.html" rel="prev" title="hadoop（18） YARN <BR /> 资源调度器、Hadoop 优化">hadoop（18） YARN<br> 资源调度器、Hadoop 优化<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="addthis_inline_share_toolbox"><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c42b60d6ef7b089" async="async"></script></div></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/icon.jpg" alt="Laiyy"><p class="site-author-name" itemprop="name">Laiyy</p><p class="site-description motion-element" itemprop="description">简介</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">83</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">19</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">35</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/laiyy0728" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:laiyy0728@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://www.jianshu.com/u/8fa6bf5f8bd9" target="_blank" title="简  书"><i class="fa fa-fw fa-book"></i> 简 书</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#计数器"><span class="nav-number">1.</span> <span class="nav-text">计数器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#示例"><span class="nav-number">1.1.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#压缩"><span class="nav-number">2.</span> <span class="nav-text">压缩</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#压缩编码"><span class="nav-number">2.1.</span> <span class="nav-text">压缩编码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#压缩方式对比"><span class="nav-number">2.2.</span> <span class="nav-text">压缩方式对比</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GZip-压缩"><span class="nav-number">2.2.1.</span> <span class="nav-text">GZip 压缩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BZip2"><span class="nav-number">2.2.2.</span> <span class="nav-text">BZip2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LZO"><span class="nav-number">2.2.3.</span> <span class="nav-text">LZO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Snappy"><span class="nav-number">2.2.4.</span> <span class="nav-text">Snappy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#压缩位置的选择"><span class="nav-number">2.3.</span> <span class="nav-text">压缩位置的选择</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#压缩参数的配置"><span class="nav-number">2.4.</span> <span class="nav-text">压缩参数的配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#示例-1"><span class="nav-number">2.5.</span> <span class="nav-text">示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#压缩测试"><span class="nav-number">2.5.1.</span> <span class="nav-text">压缩测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解压测试"><span class="nav-number">2.5.2.</span> <span class="nav-text">解压测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Map-输出端采用压缩"><span class="nav-number">2.5.3.</span> <span class="nav-text">Map 输出端采用压缩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reduce-输出压缩"><span class="nav-number">2.5.4.</span> <span class="nav-text">Reduce 输出压缩</span></a></li></ol></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_uv">UV:<span id="busuanzi_value_site_uv"></span></span></div> <span class="post-meta-divider">|</span><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_pv">PV:<span id="busuanzi_value_site_pv"></span></span></div><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">laiyy</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">网站总字数&#58;</span> <span title="网站总字数">144.5k 字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body></html><script type="text/javascript" src="/js/src/clipboard.min.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script>